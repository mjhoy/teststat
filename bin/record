#!/usr/bin/env ruby

$: << File.expand_path(File.dirname(__FILE__) + "/../lib/")
require 'codestat'

cmd = ARGV.join(" ")
fail "No test given" if cmd.empty?

reader, writer = IO.pipe
pid = spawn(cmd, [ STDERR, STDOUT ] => writer)
writer.close

puts "\n[teststats] recording..."
puts "\n"
buf = ""
STDOUT.flush
while out = reader.gets
  puts out
  buf << out
end
rc, status = Process::waitpid2(pid)

p = CodeStat::Parser.new(buf, status)
p.output_stats

db = CodeStat::DB.new("stats.db")
db.push(p.data)
